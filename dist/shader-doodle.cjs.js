'use strict';var Template={render(){return"".concat(this.css(),"\n            ").concat(this.html())},map(a){return{canvas:a.querySelector("canvas")}},html(a){return"<canvas></canvas>"},css(){return"<style>\n      :host {\n        position: relative;\n        display: inline-block;\n        width: 250px;\n        height: 250px;\n      }\n      :host > canvas {\n        position: absolute;\n        top: 0;\n        left: 0;\n        height: 100%;\n        width: 100%;\n        border-radius: inherit;\n       }\n    </style>"}};
function AudioContextResume(a){function b(a){console.log(a);k.add(a.targetElement)}function d(b){k.has(b.targetElement)?k.delete(b.targetElement):(b=a.createBufferSource(),b.buffer=a.createBuffer(1,1,a.sampleRate),b.connect(a.destination),b.start(0),"function"===typeof a.resume&&a.resume().then(c),e())}function c(){g.forEach(a=>{a()})}function e(){m.forEach(a=>{a.removeEventListener("touchstart",d);a.removeEventListener("touchmove",b);a.removeEventListener("touchend",d);a.removeEventListener("mouseup",
d)});m.clear();k.clear()}let k=new Set,m=new Set,g=[];return{onStart:function(c){"running"===a.state?(console.log("already"),c()):g.push(c)},register:function(a){a.addEventListener("touchstart",d);a.addEventListener("touchmove",b);a.addEventListener("touchend",d);a.addEventListener("mouseup",d);m.add(a)},dispose:e}}
let TIME=0,DELTA=1,DATE=2,FRAME=3,GLOBAL_UNIFORMS=[{name:"u_time",toyname:"iTime",type:"float",value:0},{name:"u_delta",toyname:"iTimeDelta",type:"float",value:0},{name:"u_date",toyname:"iDate",type:"vec4",value:[0,0,0,0]},{name:"u_frame",toyname:"iFrame",type:"int",value:0}],RESOLUTION=0,MOUSE=1,MOUSEDRAG=2,SURFACE_UNIFORMS=[{name:"u_resolution",toyname:"iResolution",type:"vec2",value:[0,0]},{name:"u_mouse",toyname:"iCurrentMouse",type:"vec2",value:[0,0]},{name:"u_mousedrag",toyname:"iMouse",type:"vec4",
value:[0,0,0,0]}],ORIENTATION=0,ORIENTATION_UNIFORMS=[{name:"u_orientation",toyname:"iOrientation",type:"vec3",value:[0,0,0]}],BASE_UNIFORM_ARRAY=[...GLOBAL_UNIFORMS,...ORIENTATION_UNIFORMS,...SURFACE_UNIFORMS],SHADERTOY_IO=/\(\s*out\s+vec4\s+(\S+)\s*,\s*in\s+vec2\s+(\S+)\s*\)/;var cheapClone=a=>JSON.parse(JSON.stringify(a));
function DeviceOrientation(){function a(a){d[ORIENTATION].value[0]=a.alpha;d[ORIENTATION].value[1]=a.beta;d[ORIENTATION].value[2]=a.gamma}let b=!1,d=cheapClone(ORIENTATION_UNIFORMS);return{get ustate(){return d},setup:function(){b||(b=!0,"object"===typeof DeviceOrientationEvent&&"function"===typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(c=>{"granted"===c&&window.addEventListener("deviceorientation",a)}).catch(console.error):window.addEventListener("deviceorientation",
a))},dispose:function(){window.removeEventListener("deviceorientation",a)}}}function Extensions(a){let b={},d=a.getExtension.bind(a);return{get:function(a){if(void 0!==b[a])return b[a];let c=d(a)||d("MOZ_".concat(a))||d("WEBKIT_".concat(a));null===c&&console.warn("<shader-doodle /> ".concat(a," extension not supported."));return b[a]=c}}}
function Renderer(){function a(a,b){if(a>p||b>r)a=Math.max(a,p),b=Math.max(b,r),a!==p&&(p=a,c.width=Math.floor(1*p)),b!==r&&(r=b,c.height=Math.floor(1*r))}function b(a){let b=l?(a-l)/1E3:0;l=a;u[TIME].value+=b;u[DELTA].value=b;u[FRAME].value++;a=new Date;u[DATE].value[0]=a.getFullYear();u[DATE].value[1]=a.getMonth()+1;u[DATE].value[2]=a.getDate();u[DATE].value[3]=3600*a.getHours()+60*a.getMinutes()+a.getSeconds()+.001*a.getMilliseconds()}function d(n){if(q.size){b(n);var e=[...u,...k.ustate];q.forEach(b=>
b.render(c,a,p,r,1,e));h=requestAnimationFrame(d)}}let c=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),e=c.getContext("webgl")||c.getContext("experimental-webgl"),k=DeviceOrientation(),m=new (window.AudioContext||window.webkitAudioContext),g=new AudioContextResume(m);m.onStart=g.onStart;let p=0,r=0,h,l,q=new Set,u=cheapClone(GLOBAL_UNIFORMS),t=Extensions(e);t.get("OES_texture_float");t.get("OES_texture_float_linear");t.get("OES_texture_half_float");t.get("OES_texture_half_float_linear");
e.clearColor(0,0,0,0);return Object.freeze({get gl(){return e},get wa(){return m},addSurface:function(a){g.register(a.dom);a.addClick(k.setup);q.add(a);h||(h=requestAnimationFrame(d))},removeSurface:function(a){q.delete(a)},dispose:function(){q.forEach(a=>a.dispose());q.clear();q=void 0;cancelAnimationFrame(h);k.dispose();g.dispose()}})}let singletonRenderer;Renderer.singleton=function(){singletonRenderer||(singletonRenderer=Renderer());return singletonRenderer};
Renderer.resetSingleton=function(){singletonRenderer&&singletonRenderer.dispose();singletonRenderer=Renderer()};class SDBaseElement extends HTMLElement{get renderer(){return Renderer.singleton()}get name(){return this.getAttribute("name")}set name(a){this.setAttribute("name",a)}}function Attributes(a,b){let d={},c=a.getProgramParameter(b,a.ACTIVE_ATTRIBUTES);for(let e=0;e<c;e++){let {name:c}=a.getActiveAttrib(b,e);d[c]=a.getAttribLocation(b,c)}return d}
function Framebuffer(a){function b(b){a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,b?a.NEAREST:a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,b?a.NEAREST:a.LINEAR)}let d,c,e=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,e);let k=a.createTexture();if(!k)throw Error("createTexture returned null");a.bindTexture(a.TEXTURE_2D,k);b(!0);a.framebufferTexture2D(a.FRAMEBUFFER,
a.COLOR_ATTACHMENT0,a.TEXTURE_2D,k,0);return{get handle(){return e},get texture(){return k},updateTexture:b,bind:function(){a.bindFramebuffer(a.FRAMEBUFFER,e);a.viewport(0,0,d,c)},updateResolution:function(b,e){if(b!==d||e!==c)d=b,c=e,a.bindTexture(a.TEXTURE_2D,k),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,e,0,a.RGBA,a.FLOAT,null)},dispose:function(){a.deleteFramebuffer(e);a.deleteTexture(k)}}}
function Shader(a,b,d){b=a.createShader(b);a.shaderSource(b,d);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS)){let c=a.getShaderInfoLog(b);a.deleteShader(b);console.warn(c,"\nin shader:\n",d)}return b}function arraysEqual(a,b){if(a.length!==b.length)return!1;for(let d=0,c=a.length;d<c;d++)if(a[d]!==b[d])return!1;return!0}function copyArray(a,b){for(let d=0,c=b.length;d<c;d++)a[d]=b[d]}function setValueV1f(a,b,d,c){a[0]!==c&&(d.uniform1f(b,c),a[0]=c)}
function setValueV2f(a,b,d,c){arraysEqual(a,c)||(d.uniform2fv(b,c),copyArray(a,c))}function setValueV3f(a,b,d,c){arraysEqual(a,c)||(d.uniform3fv(b,c),copyArray(a,c))}function setValueV4f(a,b,d,c){arraysEqual(a,c)||(d.uniform4fv(b,c),copyArray(a,c))}function setValueT1(a,b,d,c){a[0]!==c&&(d.uniform1i(b,c),a[0]=c)}
function getUniformSetter(a){switch(a){case 5126:return setValueV1f;case 35664:return setValueV2f;case 35665:return setValueV3f;case 35666:return setValueV4f;case 35678:case 36198:return setValueT1}}function Uniform(a,b,d){let c=[],e=getUniformSetter(b.type);return{get location(){return d},get name(){return b.name},setValue:function(){for(var b=arguments.length,m=Array(b),g=0;g<b;g++)m[g]=arguments[g];e(c,d,a,...m)}}}
function Uniforms(a,b){let d={},c=a.getProgramParameter(b,a.ACTIVE_UNIFORMS);for(let k=0;k<c;k++){var e=a.getActiveUniform(b,k);let c=a.getUniformLocation(b,e.name);e=Uniform(a,e,c);d[e.name]=e}return d}var resolveToy=(a,b,d)=>{if(!b)return a[d];b="toy".concat(d);return a.hasOwnProperty(b)?a[b]:a[d]},createUniformString=(a,b)=>Object.values(a).reduce((a,c)=>a+"uniform ".concat(resolveToy(c,b,"type")," ").concat(resolveToy(c,b,"name"),";\n"),"");let currentProgramId=0;
function prepareFragShader(a,b){if(b){let b=a.match(SHADERTOY_IO);a=a.replace("mainImage","main");a=a.replace(SHADERTOY_IO,"()");a=(b?"#define ".concat(b[1]," gl_FragColor\n#define ").concat(b[2]," gl_FragCoord.xy\n"):"")+a}a=createUniformString(BASE_UNIFORM_ARRAY,b)+a;return"precision highp float;\n"+a}
function Program(a,b,d,c){function e(a){let b=w[resolveToy(a,m,"name")];b&&b.setValue(resolveToy(a,m,"value"))}function k(b){b.forEach(e);y.forEach(a=>a.update(e));n&&w.u_prevbuffer&&(b=w.u_prevbuffer)&&(b.setValue(v),a.activeTexture(a["TEXTURE".concat(v)]),a.bindTexture(a.TEXTURE_2D,n.texture),n.updateTexture());x.forEach(b=>{w[b.name].setValue(b.u);a.activeTexture(a["TEXTURE".concat(b.u)]);a.bindTexture(a.TEXTURE_2D,b.fbo.texture);b.fbo.updateTexture()})}let m=4<arguments.length&&void 0!==arguments[4]?
arguments[4]:!1,g=currentProgramId++,p=a.createProgram(),r=a.createBuffer();var h=Shader(a,a.VERTEX_SHADER,b);let l=Shader(a,a.FRAGMENT_SHADER,prepareFragShader(d,m));a.attachShader(p,h);a.attachShader(p,l);a.linkProgram(p);let q,u,t,n,v,f=Attributes(a,p),w=Uniforms(a,p),x=new Set,y=new Set,A=0;if(!a.getProgramParameter(p,a.LINK_STATUS)){let b=a.getProgramInfoLog(p);console.warn(b)}a.detachShader(p,h);a.detachShader(p,l);a.deleteShader(h);a.deleteShader(l);h=f.position;a.bindBuffer(a.ARRAY_BUFFER,
r);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);a.enableVertexAttribArray(h);a.vertexAttribPointer(h,2,a.FLOAT,!1,0,0);return{get id(){return g},get nodes(){return x},get fbo(){return t},get name(){return q},get u(){return u},render:function(b,c,d){x.size&&x.forEach(a=>a.render(b,c,d));if(t){if(n){let a=t;t=n;n=a;n.bind();n.updateResolution(b,c)}t.updateResolution(b,c);t.bind()}else a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(0,0,b,c);a.clear(a.COLOR_BUFFER_BIT);a.useProgram(p);k(d);a.drawArrays(a.TRIANGLES,
0,6)},addNode:function(a,b,c){a.toFbo(b,A++,c);x.add(a)},removeNode:function(a){x.delete(a)},addTexture:function(a){y.add(a)},removeTexture:function(a){y.delete(a)},getTexUnit:function(){return A++},update:k,toFbo:function(b,c,d){q=b;u=c;t=Framebuffer(a);d&&(n=Framebuffer(a),v=A++)},dispose:function(){y.forEach(a=>{"function"===typeof a.dispose&&a.dispose()});y.clear();a.deleteProgram(p)}}}
var asyncLoadTextFromUrl=a=>new Promise((b,d)=>{let c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=()=>{c.readyState===XMLHttpRequest.DONE&&(200===c.status?b(c.responseText):d(c.status))};c.send()}),asyncGetScriptContent=async a=>a.src?asyncLoadTextFromUrl(a.src):a.text;let DEFAULT_VS="attribute vec2 position;\nvoid main() {\n  gl_Position = vec4(position, 0.0, 1.0);\n}",DEFAULT_VERTICES=new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),UNNAMED_NODE_PREFIX="u_node",unnamedNodeIndex=0;
class SDNodeElement extends SDBaseElement{disconnectedCallback(){this.program.dispose();this.program=void 0}get shadertoy(){return this.hasAttribute("shadertoy")}set shadertoy(a){a?this.setAttribute("shadertoy",""):this.removeAttribute("shadertoy")}get prevbuffer(){return this.hasAttribute("prevbuffer")}set prevbuffer(a){a?this.setAttribute("prevbuffer",""):this.removeAttribute("prevbuffer")}get vertices(){let a=this.getAttribute("vertices");if(!a)return DEFAULT_VERTICES;a=JSON.parse(a);return Array.isArray(a)?
new Float32Array(a):DEFAULT_VERTICES}set vertices(a){a&&Array.isArray(a)&&this.setAttribute("vertices",JSON.stringify(a))}get forcedHeight(){let a=this.getAttribute("data-forced-height");return a?parseInt(a):-1}set forcedHeight(a){let b=parseInt(a);a&&Number.isInteger(b)&&this.setAttribute("data-forced-height",a)}get forcedWidth(){let a=this.getAttribute("data-forced-width");return a?parseInt(a):-1}set forcedWidth(a){let b=parseInt(a);a&&Number.isInteger(b)&&this.setAttribute("data-forced-width",
a)}async init(a){a&&!this.name&&(this.name="".concat(UNNAMED_NODE_PREFIX).concat(unnamedNodeIndex++));let b=[],d,c;for(let a=0;a<this.children.length;a++){let e=this.children[a];if(e instanceof SDBaseElement)b.push(e);else switch(e.getAttribute("type")){case "x-shader/x-fragment":c=await asyncGetScriptContent(e);break;case "x-shader/x-vertex":d=await asyncGetScriptContent(e)}}d=d||DEFAULT_VS;this.program=Program(this.renderer.gl,d,c,this.vertices,this.shadertoy);b.forEach(a=>{a.init(this.program)});
a&&a.addNode(this.program,this.name,this.prevbuffer)}}customElements.get("sd-node")||customElements.define("sd-node",SDNodeElement);let PIXEL=new Uint8Array([0,0,0,255]),isPow2=a=>!(a&a-1)&&!!a,floorPowerOfTwo=a=>2**Math.floor(Math.log(a)/Math.LN2);
function Texture(a,b){function d(){a.getParameter(a.ACTIVE_TEXTURE)!==b&&a.activeTexture(a["TEXTURE".concat(b)])}function c(){r.forEach(b=>{a.texParameteri(m,b[0],b[1])})}function e(b){if("object"===typeof b){Object.assign(p,b);d();a.bindTexture(m,g);var {level:e,internalFormat:k,offsetX:n,offsetY:v,width:f,height:q,border:x,format:y,type:r,flipY:C,buffer:B,pixels:z}=p;c();a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,C);if(z){if(0===z.width||0===z.height){console.warn("Texture size is invalid ".concat(z.width,
" x ").concat(z.height,". Update is skipped;"));return}{({pixels:b}=p);let c=a.getTexParameter(m,a.TEXTURE_WRAP_S),d=a.getTexParameter(m,a.TEXTURE_WRAP_T),e=a.getTexParameter(m,a.TEXTURE_MIN_FILTER),n=isPow2(b.width)&&isPow2(b.height);c===a.CLAMP_TO_EDGE&&d===a.CLAMP_TO_EDGE&&(e===a.LINEAR||e===a.NEAREST)||n||(l||(l=document.createElement("canvas"),l.width=floorPowerOfTwo(b.width),l.height=floorPowerOfTwo(b.height),console.warn("Texture is not power of two ".concat(b.width," x ").concat(b.height,
". Resized to ").concat(l.width," x ").concat(l.height,";"))),l.getContext("2d").drawImage(b,0,0,l.width,l.height));h=l||b}}"number"===typeof n&&"number"===typeof v?h?a.texSubImage2D(m,e,n,v,y,r,h):a.texSubImage2D(m,e,n,v,f,q,y,r,B):h?a.texImage2D(m,e,k,y,r,h):a.texImage2D(m,e,k,f,q,x,y,r,B);h&&isPow2(h.width)&&isPow2(h.height)&&(b=a.getTexParameter(m,a.TEXTURE_MIN_FILTER),b!==a.LINEAR&&b!==a.NEAREST&&a.generateMipmap(m))}}let k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},m=a.TEXTURE_2D,
g=a.createTexture(),p={},r=[],h,l;e(Object.assign({level:0,internalFormat:a.RGBA,offsetX:null,offsetY:null,width:1,height:1,border:0,format:a.RGBA,type:a.UNSIGNED_BYTE,flipY:!0,buffer:PIXEL,pixels:null},"object"===typeof k?k:{}));return{setParameters:function(b){d();r.length=0;b.forEach(b=>{r.push(b);a.texParameteri(m,b[0],b[1])})},shallow:function(){d();a.bindTexture(m,g);c()},update:e,dispose:function(){a.deleteTexture(g)}}}
function asyncFetchAudioBuffer(a){return new Promise((b,d)=>{let c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onreadystatechange=()=>{c.readyState===XMLHttpRequest.DONE&&(200===c.status||206===c.status?b(c.response):(console.log(c),d(c.status)))};c.send()})}function asyncDecodeAudioBuffer(a,b){return new Promise((d,c)=>{b.decodeAudioData(a,d,c)})}
function AudioTexture(a,b,d,c,e,k,m,g){async function p(){f=l.createBufferSource();f.buffer=await asyncDecodeAudioBuffer(await asyncFetchAudioBuffer(c),l);f.loop=k;f.start();w=!0}function r(){let a=document.querySelector(c);a&&a instanceof HTMLAudioElement&&(v=a,f=l.createMediaElementSource(a))}function h(a,b){a.connect(q);q.connect(b)}e=a.gl;let l=a.wa,q=l.createAnalyser();q.fftSize=1024;let u=new Uint8Array(q.frequencyBinCount),t=new Uint8Array(q.frequencyBinCount),n=Texture(e,b,{internalFormat:e.LUMINANCE,
width:t.length,height:2,format:e.LUMINANCE,buffer:null});n.setParameters([[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE],[e.TEXTURE_MIN_FILTER,e.NEAREST]]);let v,f,w=!1,x=[{name:d,value:b}];"#"===c[0]?r():c&&p();f&&h(f,l.destination);return{update:function(a){x.forEach(a);if(w||v&&2<v.readyState&&!v.paused&&!v.ended&&v.currentTime)q.getByteFrequencyData(u),q.getByteTimeDomainData(t),n.update({offsetX:0,offsetY:0,height:1,buffer:u}),n.update({offsetX:0,offsetY:1,height:1,buffer:t})}}}
let UNNAMED_AUDIO_PREFIX="u_audio",unnamedAudioIndex=0;
class SDAudioElement extends SDBaseElement{disconnectedCallback(){this.program.removeTexture(this.texture);this.texture.dispose()}get src(){return this.getAttribute("src")}set src(a){this.setAttribute("src",a)}get autoplay(){return this.hasAttribute("autoplay")}set autoplay(a){a?this.setAttribute("autoplay",""):this.removeAttribute("autoplay")}get loop(){return this.hasAttribute("loop")}set loop(a){a?this.setAttribute("loop",""):this.removeAttribute("loop")}get crossOrigin(){return this.getAttribute("crossorigin")}set crossOrigin(a){this.setAttribute("crossorigin",a)}get mic(){return this.hasAttribute("mic")}set mic(a){a?
this.setAttribute("mic",""):this.removeAttribute("mic")}init(a){this.name||(this.name="".concat(UNNAMED_AUDIO_PREFIX).concat(unnamedAudioIndex++));this.src&&(this.program=a,this.texture=AudioTexture(this.renderer,a.getTexUnit(),this.name,this.src,this.mic,this.loop,this.autoplay,this.crossOrigin),a.addTexture(this.texture))}}customElements.get("sd-audio")||customElements.define("sd-audio",SDAudioElement);
function _defineProperty(a,b,d){b in a?Object.defineProperty(a,b,{value:d,enumerable:!0,configurable:!0,writable:!0}):a[b]=d;return a}function ownKeys(a,b){var d=Object.keys(a);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(a);b&&(c=c.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable}));d.push.apply(d,c)}return d}
function _objectSpread2(a){for(var b=1;b<arguments.length;b++){var d=null!=arguments[b]?arguments[b]:{};b%2?ownKeys(d,!0).forEach(function(b){_defineProperty(a,b,d[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(d)):ownKeys(d).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(d,b))})}return a}
let IMAGE=0,VIDEO=1,CAMERA=2,CANVAS=3,IMG_REG=/\w+\.(jpg|jpeg|png|gif|bmp)(?=\?|$)/i,isImage=a=>IMG_REG.test(a),VID_REG=/\w+\.(mp4|3gp|webm|ogv)(?=\?|$)/i,isVideo=a=>VID_REG.test(a);function addHiddenInDOM(a){let b=document.createElement("div");b.style.width=b.style.height="1px";b.style.overflow="hidden";b.style.position="absolute";b.style.opacity="0";b.style.pointerEvents="none";b.style.zIndex="-1000";b.appendChild(a);document.body.appendChild(b)}
function GeneralTexture(a,b,d,c,e,k,m,g,p,r){function h(){w=IMAGE;f=new Image;f.crossOrigin="anonymous";f.onload=l;f.onerror=()=>{console.warn("failed loading src: ".concat(c))};f.src=c}function l(){t();v.setParameters([[n.TEXTURE_WRAP_S,k],[n.TEXTURE_WRAP_T,m],[n.TEXTURE_MIN_FILTER,g],[n.TEXTURE_MAG_FILTER,p]]);v.update({pixels:f})}function q(){t();v.setParameters([[n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE],[n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE],[n.TEXTURE_MIN_FILTER,n.LINEAR]])}function u(){w=CAMERA;let a=
navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,b=a=>{f=document.createElement("video");f.width=320;f.height=240;f.autoplay=!0;f.srcObject=a;addHiddenInDOM(f);q()},c=()=>{navigator.mediaDevices.getUserMedia({video:!0}).then(b).catch(a=>console.log(a.name+": "+a.message))},d=()=>{a({video:!0},b,a=>a)};navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?c():a&&d()}function t(){f&&(x[1].value[0]=f.width,x[1].value[1]=f.height)}let n=a.gl,v=Texture(n,b),f,w,x=[{name:d,
value:b},{name:d+"_resolution",value:[0,0]}];if(e)u();else if(isVideo(c))w=VIDEO,f=document.createElement("video"),f.autoplay=!0,f.muted=!0,f.loop=!0,f.playsInline=!0,f.crossOrigin="anonymous",f.src=c,addHiddenInDOM(f),q(),f.play();else if(isImage(c))h();else{try{f=document.querySelector(c)}catch(y){console.warn("src: ".concat(c,": invalid selector"))}f?f instanceof HTMLImageElement?(w=IMAGE,f.complete?l():f.addEventListener("load",l)):f instanceof HTMLVideoElement?(w=VIDEO,q()):f instanceof HTMLCanvasElement?
(w=CANVAS,l()):console.warn("src: ".concat(c,": element is not a valid texture source")):console.warn("src: ".concat(c,": no element could be selected"))}return{update:function(a){x.forEach(a);r||(w===CAMERA||w===VIDEO)&&f instanceof HTMLVideoElement&&f.readyState===f.HAVE_ENOUGH_DATA?v.update({pixels:f}):v.shallow()}}}
let REPEAT=10497,CLAMP_TO_EDGE=33071,MIRRORED_REPEAT=33648,NEAREST=9728,LINEAR=9729,NEAREST_MIPMAP_NEAREST=9984,LINEAR_MIPMAP_NEAREST=9985,NEAREST_MIPMAP_LINEAR=9986,LINEAR_MIPMAP_LINEAR=9987,MAG_OPTIONS={NEAREST,LINEAR},MIN_OPTIONS=_objectSpread2({},MAG_OPTIONS,{NEAREST_MIPMAP_NEAREST,LINEAR_MIPMAP_NEAREST,NEAREST_MIPMAP_LINEAR,LINEAR_MIPMAP_LINEAR}),WRAP_OPTIONS={REPEAT,MIRRORED_REPEAT,CLAMP_TO_EDGE},UNNAMED_TEXTURE_PREFIX="u_texture",unnamedTextureIndex=0;
class TextureElement extends SDBaseElement{static get observedAttributes(){return"mag-filter min-filter name src wrap-s wrap-t".split(" ")}disconnectedCallback(){this.program.removeTexture(this.texture);"function"===typeof this.texture.dispose&&this.texture.dispose()}get forceUpdate(){return this.hasAttribute("force-update")}set forceUpdate(a){a?this.setAttribute("force-update",""):this.removeAttribute("force-update")}get magFilter(){return MAG_OPTIONS[this.getAttribute("mag-filter")]||LINEAR}get minFilter(){return MIN_OPTIONS[this.getAttribute("min-filter")]||
LINEAR_MIPMAP_LINEAR}get src(){return this.getAttribute("src")}set src(a){this.setAttribute("src",a)}get webcam(){return this.hasAttribute("webcam")}set webcam(a){a?this.setAttribute("webcam",""):this.removeAttribute("webcam")}get wrapS(){return WRAP_OPTIONS[this.getAttribute("wrap-s")]||REPEAT}get wrapT(){return WRAP_OPTIONS[this.getAttribute("wrap-t")]||REPEAT}init(a){this.name||(this.name="".concat(UNNAMED_TEXTURE_PREFIX).concat(unnamedTextureIndex++));if(this.src||this.webcam)this.program=a,this.texture=
GeneralTexture(this.renderer,a.getTexUnit(),this.name,this.src,this.webcam,this.wrapS,this.wrapT,this.minFilter,this.magFilter,this.forceUpdate),a.addTexture(this.texture)}}customElements.get("sd-texture")||customElements.define("sd-texture",TextureElement);let TOUCH_EVENTS=new Set(["touchstart","touchmove","touchend"]),mouseOrTouch=a=>TOUCH_EVENTS.has(a.type)&&"object"===typeof a.touches[0]?a.touches[0]:a;var getMouseOrTouch=a=>{a=mouseOrTouch(a);return[a.clientX||0,a.clientY||0]};
function Surface(a,b,d){function c(a){r.forEach(a=>"function"===typeof a&&a());t=!0;a=getMouseOrTouch(a);let {top:b,left:c,height:d}=l;h[MOUSEDRAG].value[0]=h[MOUSEDRAG].value[2]=a[0]-Math.floor(c);h[MOUSEDRAG].value[1]=h[MOUSEDRAG].value[3]=Math.floor(d)-(a[1]-Math.floor(b))}function e(a){if(!u){a=getMouseOrTouch(a);let {top:b,left:c,height:d}=l;h[MOUSE].value[0]=a[0]-Math.floor(c);h[MOUSE].value[1]=Math.floor(d)-(a[1]-Math.floor(b));t&&(h[MOUSEDRAG].value[0]=h[MOUSE].value[0],h[MOUSEDRAG].value[1]=
h[MOUSE].value[1]);u=!0}}function k(a){t=!1;1===Math.sign(h[MOUSEDRAG].value[2])&&(h[MOUSEDRAG].value[2]*=-1);1===Math.sign(h[MOUSEDRAG].value[3])&&(h[MOUSEDRAG].value[3]*=-1)}function m(){var a=g.getBoundingClientRect();q=0<=a.top+a.height&&0<=a.left+a.width&&a.bottom-a.height<=(window.innerHeight||document.documentElement.clientHeight)&&a.right-a.width<=(window.innerWidth||document.documentElement.clientWidth);let b=d.forcedHeight&&0<d.forcedHeight?d.forcedHeight:a.height;a=d.forcedWidth&&0<d.forcedWidth?
d.forcedWidth:a.width;a!==l.width&&(g.width=h[RESOLUTION].value[0]=a);b!==l.height&&(g.height=h[RESOLUTION].value[1]=b);l={width:g.width,height:g.height}}let g=a instanceof HTMLCanvasElement?a:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),p=g.getContext("2d"),r=new Set,h=cheapClone(SURFACE_UNIFORMS),l={},q,u,t;g.addEventListener("mousedown",c);g.addEventListener("mousemove",e);g.addEventListener("mouseup",k);g.addEventListener("mouseout",k);g.addEventListener("touchstart",c);g.addEventListener("touchmove",
e);g.addEventListener("touchend",k);m();return Object.freeze({get dom(){return g},render:function(a,c,d,e,g,k){m();u=!1;if(q&&b){var f=l.width||0;d=l.height||0;c(f,d);b.render(f,d,[...k,...h]);c=f*g;g*=d;p.clearRect(0,0,c,g);p.drawImage(a,0,e-g,c,g,0,0,c,g)}},addClick:function(a){r.add(a)},dispose:function(){r.clear();g.removeEventListener("mousedown",c);g.removeEventListener("mousemove",e);g.removeEventListener("mouseup",k);g.removeEventListener("mouseout",k);g.removeEventListener("touchstart",c);
g.removeEventListener("touchmove",e);g.removeEventListener("touchend",k)}})}
class ShaderDoodleElement extends SDNodeElement{constructor(){super();this.shadow=this.attachShadow({mode:"open"})}connectedCallback(){setTimeout(()=>{try{this.init()}catch(a){console.error(a&&a.message||"Error in shader-doodle.")}})}disconnectedCallback(){super.disconnectedCallback();this.renderer.removeSurface(this.surface);this.surface.dispose();this.surface=void 0}async init(){Renderer.resetSingleton();this.shadow.innerHTML=Template.render();let a=Template.map(this.shadow).canvas;await super.init();
this.surface=Surface(a,this.program,this);this.renderer.addSurface(this.surface)}}customElements.get("shader-doodle")||customElements.define("shader-doodle",ShaderDoodleElement)
